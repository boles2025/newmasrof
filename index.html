<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ù†Ø²Ù„ - Ù…. Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Tajawal) -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- html2canvas for Screenshot -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass-bg: rgba(16, 30, 45, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-gold: #f1c40f;
            --accent-teal: #1abc9c;
            --text-primary: #ecf0f1;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 90px;
        }

        /* Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .glass-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-teal);
        }

        .glass-input, .form-select, .form-control {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid var(--glass-border) !important;
            color: #fff !important;
            border-radius: 10px;
        }
        
        .glass-input:focus, .form-select:focus, .form-control:focus {
            box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.3);
            border-color: var(--accent-teal) !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* Dashboard Stats */
        .stat-card { padding: 20px 10px; }
        .stat-value { font-size: 1.6rem; font-weight: 700; margin-top: 5px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .stat-label { font-size: 0.9rem; color: rgba(255,255,255,0.7); }

        /* FAB */
        .fab-btn {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-gold), #f39c12);
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            box-shadow: 0 4px 20px rgba(241, 196, 15, 0.4);
            border: none;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .fab-btn:hover { transform: scale(1.1) rotate(90deg); }

        /* Modals */
        .modal-content {
            background: #1e2a36; 
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 20px;
        }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-footer { border-top: 1px solid rgba(255,255,255,0.1); }
        .btn-close { filter: invert(1); opacity: 0.8; }

        /* Transaction List */
        .transaction-item {
            background: rgba(255,255,255,0.03);
            margin-bottom: 8px;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }
        .transaction-item:hover { background: rgba(255,255,255,0.06); }
        
        .cat-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            margin-left: 8px;
        }

        /* Utilities */
        .text-teal { color: var(--accent-teal); }
        .text-gold { color: var(--accent-gold); }
        .text-danger-light { color: #ff7675; }
        
        /* Loading Overlay */
        #loader {
            position: fixed; inset: 0; background: #0f2027; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="spinner-border text-info mb-3" role="status"></div>
        <h5 class="text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h5>
    </div>

    <div class="container py-4">
        <!-- Header -->
        <header class="text-center mb-4">
            <h2 class="fw-bold mb-1 text-white"><i class="fas fa-home me-2 text-gold"></i>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ù†Ø²Ù„</h2>
            <p class="small text-white-50">Ù…. Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± | Ù†Ø¸Ø§Ù… Ø³Ø­Ø§Ø¨ÙŠ Ø°ÙƒÙŠ</p>
        </header>

        <!-- Month Selector -->
        <div class="glass-panel p-3 mb-4 d-flex justify-content-between align-items-center">
            <label class="fw-bold text-teal"><i class="far fa-calendar-alt ms-2"></i>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ:</label>
            <input type="month" id="monthSelector" class="form-control w-auto" style="min-width: 150px;">
        </div>

        <!-- Dashboard Summary -->
        <div class="row g-3 mb-4">
            <div class="col-4">
                <div class="glass-panel stat-card">
                    <div class="stat-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                    <div class="stat-value text-white" id="totalBudgetDisplay">0</div>
                    <small class="text-white-50">Ø¬.Ù…</small>
                </div>
            </div>
            <div class="col-4">
                <div class="glass-panel stat-card" onclick="app.showExpenseDetailsModal()" style="cursor: pointer; border-bottom: 3px solid #e74c3c;">
                    <div class="stat-label">Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
                    <div class="stat-value text-danger-light" id="totalSpentDisplay">0</div>
                    <small class="text-white-50">Ø¬.Ù…</small>
                </div>
            </div>
            <div class="col-4">
                <div class="glass-panel stat-card" style="border-bottom: 3px solid var(--accent-teal);">
                    <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                    <div class="stat-value text-teal" id="totalRemainingDisplay">0</div>
                    <small class="text-white-50">Ø¬.Ù…</small>
                </div>
            </div>
        </div>

        <!-- Add Expense Form -->
        <div class="glass-panel p-3 mb-4 position-relative overflow-hidden">
            <div class="d-flex align-items-center mb-3">
                <div class="bg-teal rounded-circle p-2 me-2"></div>
                <h5 class="m-0 fw-bold text-gold"><i class="fas fa-wallet ms-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h5>
            </div>
            
            <div class="row g-2">
                <div class="col-6 col-md-3">
                    <label class="small text-white-50 mb-1">Ø§Ù„ÙØ¦Ø©</label>
                    <select id="expenseCategory" class="form-select">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©...</option>
                    </select>
                    <!-- Remaining Badge -->
                    <div id="categoryBalanceHint" class="mt-1 small fw-bold" style="min-height: 20px; font-size: 0.8rem;"></div>
                </div>
                <div class="col-6 col-md-3">
                    <label class="small text-white-50 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="expenseAmount" placeholder="0.00" class="form-control">
                </div>
                <div class="col-12 col-md-6">
                    <label class="small text-white-50 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="expenseNotes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµØ±Ù..." class="form-control">
                </div>
                <div class="col-12 col-md-6">
                    <label class="small text-white-50 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="expenseDate" class="form-control">
                </div>
                <div class="col-12 col-md-6 d-flex align-items-end">
                    <button class="btn btn-warning w-100 fw-bold text-dark" onclick="app.addExpense()">
                        <i class="fas fa-check ms-1"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Categories Grid -->
        <h6 class="text-teal mb-3 px-1">Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h6>
        <div id="categoriesGrid" class="row g-3 mb-5">
            <!-- Categories Injected Here -->
        </div>

        <!-- Recent Transactions -->
        <div class="d-flex justify-content-between align-items-end mb-2 px-1">
            <h6 class="text-teal m-0">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</h6>
            <button class="btn btn-sm btn-outline-light rounded-pill" onclick="app.showExpenseDetailsModal()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        </div>
        <div class="glass-panel p-2 mb-5" style="max-height: 400px; overflow-y: auto;">
            <div id="transactionsList">
                <!-- Transactions injected here -->
            </div>
        </div>
    </div>

    <!-- Admin FAB -->
    <button class="fab-btn" onclick="app.openAdminModal()" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">
        <i class="fas fa-cogs"></i>
    </button>

    <!-- ADMIN MODAL -->
    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold text-gold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-pills mb-3 nav-fill" id="adminTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active rounded-pill" data-bs-toggle="tab" data-bs-target="#settingsTab">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link rounded-pill" data-bs-toggle="tab" data-bs-target="#categoriesTab">Ø§Ù„ÙØ¦Ø§Øª</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link rounded-pill" data-bs-toggle="tab" data-bs-target="#reportsTab">ØªÙ‚Ø§Ø±ÙŠØ±</button>
                        </li>
                    </ul>

                    <div class="tab-content pt-2">
                        <!-- Settings -->
                        <div class="tab-pane fade show active" id="settingsTab">
                            <div class="p-3 bg-dark bg-opacity-50 rounded mb-3">
                                <label class="mb-2 text-info">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø§Ù„Ø±Ø§ØªØ¨/Ø§Ù„Ø¯Ø®Ù„):</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-secondary border-0 text-white">Ø¬.Ù…</span>
                                    <input type="number" id="globalBudgetInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 5000">
                                    <button class="btn btn-success" onclick="app.saveGlobalSettings()">Ø­ÙØ¸</button>
                                </div>
                            </div>
                        </div>

                        <!-- Categories -->
                        <div class="tab-pane fade" id="categoriesTab">
                            <div class="card bg-dark bg-opacity-25 border-secondary mb-3">
                                <div class="card-body p-2">
                                    <h6 class="mb-2 text-gold" id="catFormTitle">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</h6>
                                    <input type="hidden" id="editCatId"> <!-- Hidden ID for editing -->
                                    <div class="input-group">
                                        <input type="text" id="newCatName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© (Ù…Ø«Ø§Ù„: Ù„Ø­ÙˆÙ…)">
                                        <input type="number" id="newCatLimit" class="form-control" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">
                                        <button class="btn btn-primary" id="saveCatBtn" onclick="app.saveCategory()">Ø¥Ø¶Ø§ÙØ©</button>
                                        <button class="btn btn-secondary d-none" id="cancelCatEditBtn" onclick="app.resetCategoryForm()">Ø¥Ù„ØºØ§Ø¡</button>
                                    </div>
                                </div>
                            </div>
                            <div id="adminCatList" class="list-group list-group-flush rounded overflow-hidden">
                                <!-- List -->
                            </div>
                        </div>

                        <!-- Reports -->
                        <div class="tab-pane fade" id="reportsTab">
                            <div id="reportContainer" class="bg-white bg-opacity-10 p-4 rounded mb-3 shadow-sm" style="font-family: 'Tajawal', sans-serif;">
                                <div id="reportPreview"></div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success flex-grow-1 py-2 fw-bold" onclick="app.shareWhatsApp()">
                                    <i class="fab fa-whatsapp fa-lg me-2"></i> Ù…Ø´Ø§Ø±ÙƒØ© ÙƒÙ†Øµ
                                </button>
                                <button class="btn btn-warning flex-grow-1 py-2 fw-bold" onclick="app.shareImage()">
                                    <i class="fas fa-image fa-lg me-2"></i> Ù…Ø´Ø§Ø±ÙƒØ© ÙƒØµÙˆØ±Ø©
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT EXPENSE MODAL -->
    <div class="modal fade" id="editExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-info">ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editExpId">
                    <div class="mb-2">
                        <label>Ø§Ù„ÙØ¦Ø©</label>
                        <select id="editExpCategory" class="form-select"></select>
                    </div>
                    <div class="mb-2">
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="number" id="editExpAmount" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <input type="text" id="editExpNotes" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="editExpDate" class="form-control">
                    </div>
                    <button class="btn btn-info w-100 fw-bold" onclick="app.updateExpense()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div class="modal fade" id="catDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="catModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between text-center mb-3 bg-black bg-opacity-25 p-2 rounded">
                        <div><small>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</small><div id="catModalLimit" class="fw-bold">0</div></div>
                        <div><small>Ø§Ù„Ù…ØµØ±ÙˆÙ</small><div id="catModalSpent" class="fw-bold text-danger">0</div></div>
                        <div><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small><div id="catModalRemaining" class="fw-bold text-success">0</div></div>
                    </div>
                    <h6 class="text-white-50 border-bottom pb-1">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</h6>
                    <ul id="catModalHistory" class="list-group list-group-flush p-0"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ALL EXPENSES TABLE MODAL -->
    <div class="modal fade" id="expenseDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover mb-0 align-middle">
                            <thead class="table-light text-dark">
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„ÙØ¦Ø©</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>ØªØ­ÙƒÙ…</th>
                                </tr>
                            </thead>
                            <tbody id="detailedExpenseTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW CONFIRMATION MODAL -->
    <div class="modal fade" id="confirmModal" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-white">
                    Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="app.executeDelete()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBVxpqtMCzKH2BTKr70gI9UUlbJuHzFEw",
            authDomain: "masrof2-9e67a.firebaseapp.com",
            databaseURL: "https://masrof2-9e67a-default-rtdb.firebaseio.com",
            projectId: "masrof2-9e67a",
            storageBucket: "masrof2-9e67a.firebasestorage.app",
            messagingSenderId: "958997909952",
            appId: "1:958997909952:web:975ba540314a6389abb825"
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); // Realtime Database

        const app = {
            state: {
                categories: {},
                expenses: {},
                settings: { globalBudget: 5000 },
                selectedMonth: new Date().toISOString().slice(0, 7),
                pendingDelete: null // To store info about what to delete
            },

            init: function() {
                // UI Init
                document.getElementById('monthSelector').value = this.state.selectedMonth;
                document.getElementById('expenseDate').valueAsDate = new Date();
                
                // Event Listeners
                document.getElementById('monthSelector').addEventListener('change', (e) => {
                    this.state.selectedMonth = e.target.value;
                    this.renderDashboard();
                });

                document.getElementById('expenseCategory').addEventListener('change', this.updateCategoryBalanceHint.bind(this));

                // Start Sync
                this.syncData();
            },

            // --- Firebase Sync ---
            syncData: function() {
                const loader = document.getElementById('loader');
                
                // Listen to Categories
                db.ref('categories').on('value', (snapshot) => {
                    this.state.categories = snapshot.val() || {};
                    this.renderCategoryOptions();
                    this.renderDashboard();
                    this.renderAdminCategories();
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                });

                // Listen to Expenses
                db.ref('expenses').on('value', (snapshot) => {
                    this.state.expenses = snapshot.val() || {};
                    this.renderDashboard();
                });

                // Listen to Settings
                db.ref('settings').on('value', (snapshot) => {
                    if(snapshot.val()) {
                        this.state.settings = snapshot.val();
                        document.getElementById('globalBudgetInput').value = this.state.settings.globalBudget;
                        this.renderDashboard();
                    }
                });
            },

            // --- Core Logic ---
            getExpensesList: function() {
                return Object.entries(this.state.expenses).map(([key, val]) => ({ id: key, ...val }));
            },

            getCategoriesList: function() {
                return Object.entries(this.state.categories).map(([key, val]) => ({ id: key, ...val }));
            },

            getFilteredExpenses: function() {
                return this.getExpensesList().filter(exp => exp.date.startsWith(this.state.selectedMonth));
            },

            // --- UI Rendering ---
            renderDashboard: function() {
                const currentExpenses = this.getFilteredExpenses();
                
                // 1. Calculations
                let totalSpent = 0;
                currentExpenses.forEach(e => totalSpent += parseFloat(e.amount));
                const totalBudget = parseFloat(this.state.settings.globalBudget) || 0;
                const remaining = totalBudget - totalSpent;

                // 2. Update Stats
                document.getElementById('totalBudgetDisplay').innerText = this.formatMoney(totalBudget);
                document.getElementById('totalSpentDisplay').innerText = this.formatMoney(totalSpent);
                document.getElementById('totalRemainingDisplay').innerText = this.formatMoney(remaining);
                document.getElementById('totalRemainingDisplay').className = `stat-value ${remaining < 0 ? 'text-danger-light' : 'text-teal'}`;

                // 3. Grid
                this.renderCategoriesGrid(currentExpenses);

                // 4. List
                this.renderTransactionsList(currentExpenses);

                // 5. Hint Update (if a category is selected in form)
                this.updateCategoryBalanceHint();
            },

            renderCategoryOptions: function() {
                const select = document.getElementById('expenseCategory');
                const editSelect = document.getElementById('editExpCategory');
                const currentVal = select.value;

                let opts = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©...</option>';
                this.getCategoriesList().forEach(cat => {
                    opts += `<option value="${cat.id}">${cat.name}</option>`;
                });
                
                select.innerHTML = opts;
                editSelect.innerHTML = opts;
                select.value = currentVal; // Restore selection if possible
            },

            updateCategoryBalanceHint: function() {
                const catId = document.getElementById('expenseCategory').value;
                const hintEl = document.getElementById('categoryBalanceHint');
                
                if(!catId || !this.state.categories[catId]) {
                    hintEl.innerText = '';
                    return;
                }

                const cat = this.state.categories[catId];
                const expenses = this.getFilteredExpenses().filter(e => e.categoryId === catId);
                const spent = expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                const remaining = parseFloat(cat.limit) - spent;

                hintEl.innerHTML = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="${remaining < 0 ? 'text-danger' : 'text-success'}">${this.formatMoney(remaining)}</span>`;
            },

            renderCategoriesGrid: function(currentExpenses) {
                const grid = document.getElementById('categoriesGrid');
                grid.innerHTML = '';

                this.getCategoriesList().forEach(cat => {
                    const spent = currentExpenses
                        .filter(e => e.categoryId === cat.id)
                        .reduce((sum, e) => sum + parseFloat(e.amount), 0);
                    
                    const limit = parseFloat(cat.limit);
                    const remaining = limit - spent;
                    const percent = Math.min((spent / limit) * 100, 100);
                    
                    // Colors
                    let barColor = 'bg-info';
                    let textColor = 'text-white';
                    if (percent > 90) { barColor = 'bg-danger'; textColor = 'text-danger-light'; }
                    else if (percent > 60) { barColor = 'bg-warning'; textColor = 'text-warning'; }

                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                        <div class="glass-card text-center" onclick="app.openCategoryDetails('${cat.id}')">
                            <h6 class="fw-bold mb-1">${cat.name}</h6>
                            <div class="small opacity-50 mb-1">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${this.formatMoney(limit)}</div>
                            <div class="h5 fw-bold ${textColor} mb-2">${this.formatMoney(remaining)}</div>
                            <div class="progress" style="height: 4px; background: rgba(255,255,255,0.1);">
                                <div class="progress-bar ${barColor}" role="progressbar" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(col);
                });
            },

            renderTransactionsList: function(expenses) {
                const list = document.getElementById('transactionsList');
                list.innerHTML = '';
                
                // Sort Descending
                const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sorted.length === 0) {
                    list.innerHTML = '<div class="text-center text-white-50 py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
                    return;
                }

                sorted.forEach(exp => {
                    const catName = this.state.categories[exp.categoryId]?.name || 'Ù…Ø­Ø°ÙˆÙ';
                    const div = document.createElement('div');
                    div.className = 'transaction-item';
                    div.style.borderLeftColor = this.getColorForAmount(exp.amount);
                    div.innerHTML = `
                        <div class="d-flex flex-column">
                            <span class="fw-bold text-white">${catName}</span>
                            <small class="text-white-50" style="font-size:0.75rem">
                                ${exp.date} ${exp.notes ? ' | ' + exp.notes : ''}
                            </small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="fw-bold text-gold ms-3">${this.formatMoney(exp.amount)}</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info border-0 p-1" onclick="app.prepEditExpense('${exp.id}')"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-outline-danger border-0 p-1" onclick="app.deleteExpense('${exp.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            // --- Actions ---

            openAdminModal: function() {
                this.renderAdminCategories();
                this.generateReportPreview();
                new bootstrap.Modal(document.getElementById('adminModal')).show();
            },

            generateReportPreview: function() {
                const currentExpenses = this.getFilteredExpenses();
                // Get Arabic formatted date
                const date = new Date();
                const dateStr = date.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                let totalSpent = 0;
                let categoriesHtml = '';

                this.getCategoriesList().forEach(cat => {
                    const spent = currentExpenses.filter(e => e.categoryId === cat.id)
                                    .reduce((sum, e) => sum + parseFloat(e.amount), 0);
                    totalSpent += spent;
                    const rem = cat.limit - spent;
                    const colorClass = rem < 0 ? 'text-danger' : 'text-success';
                    
                    categoriesHtml += `
                        <div class="d-flex justify-content-between border-bottom border-secondary py-2">
                            <span class="fw-bold text-white-50">${cat.name}</span>
                            <span class="small">
                                <span class="text-white-50">ØµØ±Ù:</span> <span class="fw-bold text-white ms-1">${this.formatMoney(spent)}</span>
                                <span class="mx-1">|</span>
                                <span class="text-white-50">Ù…ØªØ¨Ù‚ÙŠ:</span> <span class="fw-bold ${colorClass}">${this.formatMoney(rem)}</span>
                            </span>
                        </div>
                    `;
                });
                
                const globalBudget = this.state.settings.globalBudget || 0;
                const totalRemaining = globalBudget - totalSpent;
                const remColor = totalRemaining < 0 ? '#ff7675' : '#1abc9c';

                const html = `
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <h4 class="text-gold fw-bold mb-1"><i class="fas fa-file-invoice-dollar me-2"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h4>
                        <div class="badge bg-secondary bg-opacity-50 text-light mt-2 p-2 fw-normal" style="font-size: 0.9rem;">
                            <i class="far fa-clock me-1"></i> ${dateStr}
                        </div>
                    </div>

                    <!-- Categories List -->
                    <div class="p-3 mb-4 rounded" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
                        <h6 class="text-teal mb-3 border-bottom border-secondary pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª</h6>
                        ${categoriesHtml}
                    </div>

                    <!-- Totals Cards -->
                    <div class="row text-center g-2 mb-4">
                        <div class="col-4">
                            <div class="p-3 rounded border border-secondary" style="background: rgba(255,255,255,0.05);">
                                <small class="d-block text-white-50 mb-1">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</small>
                                <strong class="h5 d-block text-white mb-0">${this.formatMoney(globalBudget)}</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded border border-danger border-opacity-50" style="background: rgba(220, 53, 69, 0.1);">
                                <small class="d-block text-danger-light mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ±Ù</small>
                                <strong class="h5 d-block text-danger-light mb-0">${this.formatMoney(totalSpent)}</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded border border-success border-opacity-50" style="background: rgba(25, 135, 84, 0.1);">
                                <small class="d-block text-teal mb-1">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</small>
                                <strong class="h5 d-block mb-0" style="color: ${remColor}">${this.formatMoney(totalRemaining)}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="text-center pt-3 border-top border-secondary">
                        <div class="d-inline-flex align-items-center justify-content-center px-3 py-1 rounded-pill" style="background: rgba(241, 196, 15, 0.1); border: 1px solid rgba(241, 196, 15, 0.2);">
                            <small class="text-gold" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-code me-1"></i> ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±
                            </small>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportPreview').innerHTML = html;
            },

            shareWhatsApp: function() {
                const currentExpenses = this.getFilteredExpenses();
                let text = `*ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ - Ø´Ù‡Ø± ${this.state.selectedMonth}* %0a`;
                
                let totalSpent = 0;
                this.getCategoriesList().forEach(cat => {
                    const spent = currentExpenses.filter(e => e.categoryId === cat.id)
                                    .reduce((sum, e) => sum + parseFloat(e.amount), 0);
                    totalSpent += spent;
                    const rem = cat.limit - spent;
                    text += `ğŸ“Œ *${cat.name}:* ØµØ±Ù ${Math.round(spent)} (Ù…ØªØ¨Ù‚ÙŠ ${Math.round(rem)}) %0a`;
                });

                text += `------------------%0a`;
                text += `ğŸ’° *Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ:* ${Math.round(totalSpent)} / ${this.state.settings.globalBudget}`;

                window.open(`https://wa.me/?text=${text}`, '_blank');
            },

            shareImage: function() {
                const element = document.getElementById('reportPreview');
                
                // Show loading or feedback
                const btn = event.currentTarget;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...';
                
                html2canvas(element, {
                    backgroundColor: '#1e2a36', // Ensure dark background for the image
                    scale: 2 // Higher resolution
                }).then(canvas => {
                    canvas.toBlob(blob => {
                        const file = new File([blob], "Expenses_Report.png", { type: "image/png" });
                        
                        // Check if Web Share API supports files (Mobile mostly)
                        if (navigator.share && navigator.canShare({ files: [file] })) {
                            navigator.share({
                                files: [file],
                                title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',
                                text: 'ØªÙ‚Ø±ÙŠØ± Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ù†Ø²Ù„ - Ù…. Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±'
                            }).catch(console.error);
                        } else {
                            // Fallback for Desktop: Download the image
                            const link = document.createElement('a');
                            link.download = 'House_Report.png';
                            link.href = canvas.toDataURL();
                            link.click();
                            alert('ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.');
                        }
                        btn.innerHTML = originalText;
                    });
                }).catch(err => {
                    console.error(err);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©');
                    btn.innerHTML = originalText;
                });
            },

            // 1. Add Expense
            addExpense: function() {
                const catId = document.getElementById('expenseCategory').value;
                const amount = document.getElementById('expenseAmount').value;
                const date = document.getElementById('expenseDate').value;
                const notes = document.getElementById('expenseNotes').value;

                if (!catId || !amount || !date) {
                    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');
                    return;
                }

                const newRef = db.ref('expenses').push();
                newRef.set({
                    categoryId: catId,
                    amount: parseFloat(amount),
                    date: date,
                    notes: notes || ''
                }).then(() => {
                    // Reset Form
                    document.getElementById('expenseAmount').value = '';
                    document.getElementById('expenseNotes').value = '';
                    this.updateCategoryBalanceHint(); // Refresh hint
                }).catch(err => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + err.message));
            },

            // 2. Delete Expense (NEW)
            deleteExpense: function(id) {
                this.state.pendingDelete = { type: 'expense', id: id };
                new bootstrap.Modal(document.getElementById('confirmModal')).show();
            },

            // 3. Edit Expense (Prep & Execute)
            prepEditExpense: function(id) {
                const exp = this.state.expenses[id];
                if(!exp) return;

                document.getElementById('editExpId').value = id;
                document.getElementById('editExpCategory').value = exp.categoryId;
                document.getElementById('editExpAmount').value = exp.amount;
                document.getElementById('editExpNotes').value = exp.notes || '';
                document.getElementById('editExpDate').value = exp.date;

                new bootstrap.Modal(document.getElementById('editExpenseModal')).show();
            },

            updateExpense: function() {
                const id = document.getElementById('editExpId').value;
                const catId = document.getElementById('editExpCategory').value;
                const amount = document.getElementById('editExpAmount').value;
                const date = document.getElementById('editExpDate').value;
                const notes = document.getElementById('editExpNotes').value;

                db.ref('expenses/' + id).update({
                    categoryId: catId,
                    amount: parseFloat(amount),
                    date: date,
                    notes: notes
                }).then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('editExpenseModal')).hide();
                });
            },

            // 4. Admin Settings
            saveGlobalSettings: function() {
                const val = document.getElementById('globalBudgetInput').value;
                db.ref('settings').set({ globalBudget: parseFloat(val) });
            },

            // 5. Category Management (Add/Edit)
            renderAdminCategories: function() {
                const list = document.getElementById('adminCatList');
                list.innerHTML = '';
                this.getCategoriesList().forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item bg-dark bg-opacity-50 text-white d-flex justify-content-between align-items-center mb-1 border-0 rounded';
                    item.innerHTML = `
                        <span>
                            <span class="fw-bold text-info">${cat.name}</span> 
                            <small class="text-white-50 mx-2">(${cat.limit} Ø¬.Ù…)</small>
                        </span>
                        <div>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="app.prepEditCategory('${cat.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="app.deleteCategory('${cat.id}')">Ø­Ø°Ù</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            },

            prepEditCategory: function(id) {
                const cat = this.state.categories[id];
                if(!cat) return;

                document.getElementById('catFormTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©';
                document.getElementById('editCatId').value = id;
                document.getElementById('newCatName').value = cat.name;
                document.getElementById('newCatLimit').value = cat.limit;
                
                document.getElementById('saveCatBtn').innerText = 'ØªØ­Ø¯ÙŠØ«';
                document.getElementById('saveCatBtn').className = 'btn btn-warning';
                document.getElementById('cancelCatEditBtn').classList.remove('d-none');
            },

            resetCategoryForm: function() {
                document.getElementById('catFormTitle').innerText = 'Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                document.getElementById('editCatId').value = '';
                document.getElementById('newCatName').value = '';
                document.getElementById('newCatLimit').value = '';
                
                document.getElementById('saveCatBtn').innerText = 'Ø¥Ø¶Ø§ÙØ©';
                document.getElementById('saveCatBtn').className = 'btn btn-primary';
                document.getElementById('cancelCatEditBtn').classList.add('d-none');
            },

            saveCategory: function() {
                const id = document.getElementById('editCatId').value;
                const name = document.getElementById('newCatName').value;
                const limit = document.getElementById('newCatLimit').value;

                if(!name || !limit) return;

                if(id) {
                    // Update
                    db.ref('categories/' + id).update({ name, limit: parseFloat(limit) })
                      .then(() => this.resetCategoryForm());
                } else {
                    // Create
                    db.ref('categories').push({ name, limit: parseFloat(limit) })
                      .then(() => this.resetCategoryForm());
                }
            },

            // 6. Delete Category (NEW)
            deleteCategory: function(id) {
                this.state.pendingDelete = { type: 'category', id: id };
                new bootstrap.Modal(document.getElementById('confirmModal')).show();
            },

            // 7. Execute Deletion (Triggered by Modal)
            executeDelete: function() {
                if(!this.state.pendingDelete) return;

                const { type, id } = this.state.pendingDelete;
                
                if (type === 'category') {
                     db.ref('categories/' + id).remove().catch(err => alert("Ø®Ø·Ø£: " + err.message));
                } else if (type === 'expense') {
                     db.ref('expenses/' + id).remove().catch(err => alert("Ø®Ø·Ø£: " + err.message));
                }
                
                // Hide and Reset
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
                this.state.pendingDelete = null;
            },

            // --- Modals & Reports ---
            openCategoryDetails: function(catId) {
                const cat = this.state.categories[catId];
                if(!cat) return;

                const exps = this.getFilteredExpenses().filter(e => e.categoryId === catId);
                const spent = exps.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                const remaining = parseFloat(cat.limit) - spent;

                document.getElementById('catModalTitle').innerText = cat.name;
                document.getElementById('catModalLimit').innerText = this.formatMoney(cat.limit);
                document.getElementById('catModalSpent').innerText = this.formatMoney(spent);
                document.getElementById('catModalRemaining').innerText = this.formatMoney(remaining);

                const hist = document.getElementById('catModalHistory');
                hist.innerHTML = '';
                exps.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(e => {
                    hist.innerHTML += `
                        <li class="list-group-item bg-transparent text-white border-bottom border-secondary d-flex justify-content-between align-items-center">
                            <span>
                                <div class="fw-bold">${this.formatMoney(e.amount)}</div>
                                <small class="text-white-50">${e.date}</small>
                            </span>
                            <span class="small text-info">${e.notes || ''}</span>
                        </li>`;
                });

                new bootstrap.Modal(document.getElementById('catDetailsModal')).show();
            },

            showExpenseDetailsModal: function() {
                const exps = this.getFilteredExpenses().sort((a,b) => new Date(b.date) - new Date(a.date));
                const tbody = document.getElementById('detailedExpenseTable');
                tbody.innerHTML = '';

                exps.forEach(e => {
                    const catName = this.state.categories[e.categoryId]?.name || '-';
                    tbody.innerHTML += `
                        <tr>
                            <td>${e.date}</td>
                            <td><span class="badge bg-secondary">${catName}</span></td>
                            <td><small class="text-white-50">${e.notes || ''}</small></td>
                            <td class="fw-bold text-gold">${this.formatMoney(e.amount)}</td>
                            <td>
                                <button class="btn btn-sm btn-link text-info p-0" onclick="app.prepEditExpense('${e.id}'); bootstrap.Modal.getInstance(document.getElementById('expenseDetailsModal')).hide();"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="app.deleteExpense('${e.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                new bootstrap.Modal(document.getElementById('expenseDetailsModal')).show();
            },

            // Utility
            formatMoney: function(amount) {
                return new Intl.NumberFormat('en-EG').format(amount);
            },
            getColorForAmount: function(amount) {
                if(amount > 500) return '#e74c3c';
                if(amount > 200) return '#f1c40f';
                return '#1abc9c';
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
