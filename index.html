<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª</title>

  <!-- Bootstrap RTL -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3a0ca3;
      --success-color: #4cc9f0;
      --danger-color: #f72585;
      --warning-color: #ff9e00;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --card-shadow: 0 8px 25px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 10px;
    }

    /* Header Styles */
    .brand-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 15px;
      padding: 1.2rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .brand-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255,255,255,0.1);
      transform: rotate(30deg);
    }

    .brand-title {
      font-weight: 800;
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
      position: relative;
    }

    .brand-subtitle {
      opacity: 0.9;
      font-size: 0.8rem;
      position: relative;
    }

    /* Month Selector */
    .month-selector {
      background: white;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .month-selector label {
      font-weight: 600;
      margin-bottom: 0;
      font-size: 0.9rem;
      color: var(--dark-color);
    }

    /* Budget Summary Banner */
    .budget-summary-banner {
      background: white;
      border-radius: 12px;
      padding: 0.8rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      font-size: 0.85rem;
    }

    .budget-item {
      text-align: center;
      padding: 0.3rem;
    }

    .budget-value {
      font-weight: 700;
      font-size: 0.95rem;
      font-family: 'Courier New', monospace;
    }

    /* Card Styles */
    .modern-card {
      background: white;
      border-radius: 16px;
      border: none;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .card-header-custom {
      background: transparent;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 1rem 1.2rem;
      font-weight: 700;
      color: var(--dark-color);
      font-size: 1rem;
    }

    .card-body-custom {
      padding: 1.2rem;
    }

    /* Button Styles */
    .btn-custom {
      border-radius: 10px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      font-size: 0.9rem;
    }

    .btn-primary-custom {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-success-custom {
      background: linear-gradient(135deg, #4cc9f0, #4895ef);
      color: white;
    }

    .btn-outline-custom {
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      background: transparent;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .btn-outline-custom:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Form Controls */
    .form-control-custom, .form-select-custom {
      border-radius: 10px;
      padding: 0.6rem 0.8rem;
      border: 1px solid #e9ecef;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .form-control-custom:focus, .form-select-custom:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.2);
    }

    /* Small Inputs for Mobile */
    .small-input-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .small-input {
      flex: 1;
      min-width: 0; /* Important for flexbox to shrink properly */
    }

    /* Category Accordion */
    .category-accordion {
      margin-bottom: 1rem;
    }

    .accordion-button {
      border-radius: 10px !important;
      padding: 0.8rem 1rem;
      font-weight: 600;
      background: rgba(67, 97, 238, 0.05);
      border: 1px solid rgba(67, 97, 238, 0.2);
    }

    .accordion-button:not(.collapsed) {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary-color);
      box-shadow: none;
    }

    .accordion-button:focus {
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.2);
    }

    .category-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .category-detail-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.6rem;
      text-align: center;
      border: 1px solid #e9ecef;
    }

    .category-detail-value {
      font-weight: 700;
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
    }

    .category-detail-label {
      font-size: 0.75rem;
      color: #6c757d;
      margin-bottom: 0.2rem;
    }

    /* Table Styles - Responsive */
    .table-responsive-custom {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1rem;
    }

    .table-custom {
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 10px;
      overflow: hidden;
      min-width: 600px; /* Ensures all columns are visible */
      width: 100%;
      font-size: 0.85rem;
    }

    .table-custom thead th {
      background-color: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      font-weight: 700;
      color: var(--dark-color);
      padding: 0.8rem;
      white-space: nowrap;
    }

    .table-custom tbody td {
      padding: 0.8rem;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .table-custom tbody tr:hover {
      background-color: rgba(67, 97, 238, 0.03);
    }

    /* Mobile specific table adjustments */
    @media (max-width: 768px) {
      .table-custom {
        font-size: 0.8rem;
      }
      
      .table-custom thead th,
      .table-custom tbody td {
        padding: 0.6rem 0.4rem;
      }
    }

    /* Tabs */
    .nav-tabs-custom {
      border-bottom: 2px solid #e9ecef;
    }

    .nav-tabs-custom .nav-link {
      border-radius: 8px 8px 0 0;
      border: none;
      padding: 0.6rem 1rem;
      font-weight: 600;
      color: #6c757d;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .nav-tabs-custom .nav-link.active {
      color: var(--primary-color);
      background-color: rgba(67, 97, 238, 0.1);
      border-bottom: 3px solid var(--primary-color);
    }

    /* Login Card */
    .login-card {
      max-width: 500px;
      margin: 1.5rem auto;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .login-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.2rem;
      text-align: center;
    }

    .login-body {
      padding: 1.5rem;
    }

    /* Report Share Button */
    .report-share-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: var(--transition);
    }

    .report-share-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    /* WhatsApp Report Modal */
    .whatsapp-report {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 0;
      border: 1px solid #e9ecef;
    }

    .whatsapp-report-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #25D366;
    }

    .whatsapp-report-title {
      color: #25D366;
      font-weight: 700;
      font-size: 1.2rem;
    }

    .whatsapp-report-section {
      margin-bottom: 1.2rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .whatsapp-report-section-title {
      font-weight: 700;
      color: var(--dark-color);
      margin-bottom: 0.8rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
    }

    .whatsapp-report-section-title i {
      margin-left: 0.5rem;
    }

    /* Utilities */
    .text-gradient {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .mono {
      font-variant-numeric: tabular-nums;
      font-family: 'Courier New', monospace;
    }

    .shadow-soft {
      box-shadow: 0 5px 15px rgba(0,0,0,.05);
    }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .brand-title {
        font-size: 1.3rem;
      }
      
      .brand-subtitle {
        font-size: 0.75rem;
      }
      
      .month-selector {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .month-selector > div {
        width: 100%;
      }
      
      .budget-summary-banner {
        padding: 0.6rem;
      }
      
      .budget-item {
        padding: 0.2rem;
        font-size: 0.8rem;
      }
      
      .budget-value {
        font-size: 0.85rem;
      }
      
      .card-header-custom {
        padding: 0.8rem 1rem;
        font-size: 0.95rem;
      }
      
      .card-body-custom {
        padding: 1rem;
      }
      
      .btn-custom {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }
      
      .form-control-custom, .form-select-custom {
        padding: 0.5rem 0.7rem;
        font-size: 0.85rem;
      }
      
      .small-input-container {
        flex-direction: column;
        gap: 0.3rem;
      }
    }

    @media (max-width: 576px) {
      .app-shell {
        padding: 0 5px;
      }
      
      .brand-header {
        padding: 1rem;
      }
      
      .category-details-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>

<div class="container py-3 app-shell">

  <!-- Header -->
  <div class="brand-header fade-in">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div class="brand-title">
          <i class="fas fa-money-bill-wave me-2"></i>
          Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª
        </div>
        <div class="brand-subtitle">
          Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø¯Ù‚Ø© ÙˆØ³Ù‡ÙˆÙ„Ø©
        </div>
      </div>
      <button id="btnRole" class="btn btn-light btn-custom">
        <i class="fas fa-user me-2"></i>Ø§Ù„Ø¯Ø®ÙˆÙ„
      </button>
    </div>
  </div>

  <!-- Month Selector -->
  <div id="monthSelectorContainer" class="month-selector d-none">
    <label for="monthFilter">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
    <div style="width: 200px;">
      <input id="monthFilter" type="month" class="form-control form-control-custom" />
    </div>
  </div>

  <!-- Budget Summary Banner -->
  <div id="budgetSummary" class="budget-summary-banner d-none">
    <div class="row g-0">
      <div class="col-4 budget-item">
        <div class="text-muted small">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
        <div class="budget-value text-primary" id="totalBudgetText">â€”</div>
      </div>
      <div class="col-4 budget-item">
        <div class="text-muted small">Ø§Ù„ØµØ±Ù</div>
        <div class="budget-value text-warning" id="totalSpentText">â€”</div>
      </div>
      <div class="col-4 budget-item">
        <div class="text-muted small">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
        <div class="budget-value text-success" id="totalRemainingText">â€”</div>
      </div>
    </div>
  </div>

  <!-- Login / Role Card -->
  <div id="loginView" class="login-card d-none">
    <div class="login-header">
      <h4 class="mb-0"><i class="fas fa-lock me-2"></i>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
    </div>
    <div class="login-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label fw-bold">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <select id="roleSelect" class="form-select form-select-custom">
            <option value="user" selected>Ù…Ø³ØªØ®Ø¯Ù…</option>
            <option value="admin">Ø£Ø¯Ù…Ù†</option>
          </select>
        </div>
        <div class="col-md-6" id="adminPassWrap" style="display:none;">
          <label class="form-label fw-bold">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†</label>
          <input id="adminPass" type="password" class="form-control form-control-custom" placeholder="Ø§ÙØªØ±Ø§Ø¶ÙŠ: 1234" />
        </div>
        <div class="col-12 mt-3">
          <button id="btnEnter" class="btn btn-success-custom btn-custom w-100 py-2">
            <i class="fas fa-sign-in-alt me-2"></i>Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
          </button>
        </div>
      </div>
      <div class="mt-3 p-2 bg-light rounded">
        <div class="d-flex">
          <i class="fas fa-info-circle text-primary me-2 mt-1"></i>
          <div class="small">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (localStorage). ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div id="mainTabs" class="d-none mb-3">
    <ul class="nav nav-tabs nav-tabs-custom">
      <li class="nav-item">
        <button class="nav-link active" id="tabUser">
          <i class="fas fa-user me-2"></i>Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="tabAdmin">
          <i class="fas fa-cog me-2"></i>Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
        </button>
      </li>
    </ul>
  </div>

  <!-- USER VIEW -->
  <div id="userView" class="d-none">
    <div class="row g-3">

      <!-- Left Column - Add Expense -->
      <div class="col-12">
        <div class="modern-card">
          <div class="card-header-custom">
            <div class="fs-5 fw-bold text-gradient">
              <i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯
            </div>
          </div>
          <div class="card-body-custom">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label fw-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input id="expDate" type="date" class="form-control form-control-custom" />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">Ø§Ù„ÙØ¦Ø©</label>
                <select id="expCategory" class="form-select form-select-custom"></select>
              </div>
              <div class="col-12">
                <div class="small-input-container">
                  <div class="small-input">
                    <label class="form-label fw-bold small">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input id="expAmount" type="number" min="0" step="0.01" class="form-control form-control-custom" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
                  </div>
                  <div class="small-input">
                    <label class="form-label fw-bold small">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
                    <input id="expRemaining" type="text" class="form-control form-control-custom" disabled style="background-color: #f8f9fa;" />
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <input id="expNotes" type="text" class="form-control form-control-custom" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ" />
              </div>
              <div class="col-12 mt-2">
                <button id="btnAddExpense" class="btn btn-primary-custom btn-custom w-100 py-2">
                  <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Accordion -->
      <div class="col-12">
        <div class="modern-card">
          <div class="card-header-custom">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fs-5 fw-bold text-gradient">
                <i class="fas fa-chart-bar me-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ¦Ø§Øª
              </div>
            </div>
          </div>
          <div class="card-body-custom">
            <div class="category-accordion" id="categoryAccordion">
              <!-- Will be filled dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- Expenses Table -->
      <div class="col-12">
        <div class="modern-card">
          <div class="card-header-custom">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fs-5 fw-bold text-gradient">
                <i class="fas fa-receipt me-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
              </div>
              <button id="btnExportCsv" class="btn btn-outline-custom btn-custom">
                <i class="fas fa-download me-2"></i>CSV
              </button>
            </div>
          </div>
          <div class="card-body-custom">
            <div class="table-responsive-custom">
              <table class="table table-custom">
                <thead>
                  <tr>
                    <th class="text-nowrap">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th class="text-nowrap">Ø§Ù„ÙØ¦Ø©</th>
                    <th class="text-nowrap">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th class="text-nowrap">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    <th class="text-nowrap text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                  </tr>
                </thead>
                <tbody id="expensesTbody"></tbody>
              </table>
            </div>
            <div id="noExpenses" class="muted text-center py-4 d-none">
              <i class="fas fa-receipt fa-2x text-muted mb-3"></i>
              <div class="fs-5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>
              <div class="text-muted mt-2">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ADMIN VIEW -->
  <div id="adminView" class="d-none">
    <div class="row g-3">
      <div class="col-12">
        <div class="modern-card">
          <div class="card-header-custom">
            <div class="fs-5 fw-bold text-gradient">
              <i class="fas fa-sliders-h me-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            </div>
          </div>
          <div class="card-body-custom">
            <div class="mb-3">
              <label class="form-label fw-bold">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</label>
              <div class="input-group">
                <input id="adminTotalBudget" type="number" min="0" step="0.01" class="form-control form-control-custom" placeholder="Ù…Ø«Ø§Ù„: 5000" />
                <button id="btnSaveTotalBudget" class="btn btn-success-custom btn-custom">
                  <i class="fas fa-save me-2"></i>Ø­ÙØ¸
                </button>
              </div>
            </div>

            <hr class="my-3">

            <div class="mb-3">
              <div class="fs-5 fw-bold text-gradient mb-2">
                <i class="fas fa-tags me-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª
              </div>
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label>
                  <input id="catName" class="form-control form-control-custom" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙƒÙ„" />
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø©</label>
                  <input id="catMin" type="number" min="0" step="0.01" class="form-control form-control-custom" placeholder="Ù…Ø«Ø§Ù„: 1000" />
                </div>
                <div class="col-12 mt-2">
                  <button id="btnAddCategory" class="btn btn-primary-custom btn-custom w-100 py-2">
                    <i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©
                  </button>
                  <input id="catEditingId" type="hidden" />
                </div>
              </div>
            </div>

            <hr class="my-3">

            <div class="mb-3">
              <div class="fw-bold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª</div>
              <div class="table-responsive-custom">
                <table class="table table-custom">
                  <thead>
                    <tr>
                      <th>Ø§Ù„ÙØ¦Ø©</th>
                      <th class="text-nowrap">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</th>
                      <th class="text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody id="catsTbody"></tbody>
                </table>
              </div>
            </div>

            <hr class="my-3">

            <div class="mb-3">
              <div class="fw-bold mb-2">Ø£Ù…Ø§Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</div>
              <label class="form-label">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†</label>
              <div class="input-group">
                <input id="newAdminPass" type="password" class="form-control form-control-custom" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
                <button id="btnChangePass" class="btn btn-outline-custom btn-custom">
                  <i class="fas fa-key me-2"></i>ØªØºÙŠÙŠØ±
                </button>
              </div>
              <div class="small text-muted mt-1">* ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- WhatsApp Share Button -->
<button id="whatsappShareBtn" class="report-share-btn d-none">
  <i class="fab fa-whatsapp"></i>
</button>

<!-- WhatsApp Report Modal -->
<div class="modal fade" id="whatsappReportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-card">
      <div class="modal-header card-header-custom">
        <h5 class="modal-title text-gradient">
          <i class="fab fa-whatsapp me-2"></i>ØªÙ‚Ø§Ø±ÙŠØ± ÙˆÙ…Ø´Ø§Ø±ÙƒØ©
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body card-body-custom">
        <div class="whatsapp-report">
          <div class="whatsapp-report-header">
            <div class="whatsapp-report-title">
              <i class="fab fa-whatsapp me-2"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ
            </div>
            <div class="text-muted small" id="reportMonth">Ø´Ù‡Ø± 2023-01</div>
          </div>
          
          <div class="whatsapp-report-section">
            <div class="whatsapp-report-section-title">
              <i class="fas fa-chart-pie me-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
            </div>
            <div class="row g-2">
              <div class="col-4 text-center">
                <div class="small text-muted">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                <div class="fw-bold" id="reportTotalBudget">0 Ø¬</div>
              </div>
              <div class="col-4 text-center">
                <div class="small text-muted">Ø§Ù„ØµØ±Ù</div>
                <div class="fw-bold" id="reportTotalSpent">0 Ø¬</div>
              </div>
              <div class="col-4 text-center">
                <div class="small text-muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                <div class="fw-bold" id="reportTotalRemaining">0 Ø¬</div>
              </div>
            </div>
          </div>
          
          <div class="whatsapp-report-section">
            <div class="whatsapp-report-section-title">
              <i class="fas fa-tags me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª
            </div>
            <div id="reportCategoriesDetails">
              <!-- Will be filled dynamically -->
            </div>
          </div>
          
          <div class="whatsapp-report-section">
            <div class="whatsapp-report-section-title">
              <i class="fas fa-lightbulb me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØªÙˆØµÙŠØ§Øª
            </div>
            <div id="reportRecommendations">
              <!-- Will be filled dynamically -->
            </div>
          </div>
        </div>
        
        <div class="mt-3">
          <button id="btnCopyReport" class="btn btn-outline-custom btn-custom w-100 mb-2">
            <i class="fas fa-copy me-2"></i>Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          </button>
          <a id="whatsappShareLink" target="_blank" class="btn btn-success-custom btn-custom w-100">
            <i class="fab fa-whatsapp me-2"></i>Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v8 (matching your snippet) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /**********************
   * Firebase Config (from you)
   **********************/
  const firebaseConfig = {
    apiKey: "AIzaSyCBVxpqtMCzKH2BTKr70gI9UUlbJuHzFEw",
    authDomain: "masrof2-9e67a.firebaseapp.com",
    databaseURL: "https://masrof2-9e67a-default-rtdb.firebaseio.com",
    projectId: "masrof2-9e67a",
    storageBucket: "masrof2-9e67a.firebasestorage.app",
    messagingSenderId: "958997909952",
    appId: "1:958997909952:web:975ba540314a6389abb825"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  /**********************
   * Simple Local Role Auth (Demo)
   **********************/
  const LS_ROLE = 'he_role';
  const LS_ADMIN_PASS = 'he_admin_pass';
  const DEFAULT_ADMIN_PASS = '1234';

  if (!localStorage.getItem(LS_ADMIN_PASS)) localStorage.setItem(LS_ADMIN_PASS, DEFAULT_ADMIN_PASS);

  /**********************
   * DOM
   **********************/
  const loginView = document.getElementById('loginView');
  const roleSelect = document.getElementById('roleSelect');
  const adminPassWrap = document.getElementById('adminPassWrap');
  const adminPass = document.getElementById('adminPass');
  const btnEnter = document.getElementById('btnEnter');

  const btnRole = document.getElementById('btnRole');
  const mainTabs = document.getElementById('mainTabs');
  const tabUser = document.getElementById('tabUser');
  const tabAdmin = document.getElementById('tabAdmin');

  const userView = document.getElementById('userView');
  const adminView = document.getElementById('adminView');
  
  // Month selector and budget summary
  const monthSelectorContainer = document.getElementById('monthSelectorContainer');
  const budgetSummary = document.getElementById('budgetSummary');
  
  // User
  const monthFilter = document.getElementById('monthFilter');
  const expDate = document.getElementById('expDate');
  const expCategory = document.getElementById('expCategory');
  const expAmount = document.getElementById('expAmount');
  const expRemaining = document.getElementById('expRemaining');
  const expNotes = document.getElementById('expNotes');
  const btnAddExpense = document.getElementById('btnAddExpense');
  const categoryAccordion = document.getElementById('categoryAccordion');
  const expensesTbody = document.getElementById('expensesTbody');
  const noExpenses = document.getElementById('noExpenses');
  const btnExportCsv = document.getElementById('btnExportCsv');

  const totalBudgetText = document.getElementById('totalBudgetText');
  const totalSpentText = document.getElementById('totalSpentText');
  const totalRemainingText = document.getElementById('totalRemainingText');

  // Admin
  const adminTotalBudget = document.getElementById('adminTotalBudget');
  const btnSaveTotalBudget = document.getElementById('btnSaveTotalBudget');
  const catName = document.getElementById('catName');
  const catMin = document.getElementById('catMin');
  const btnAddCategory = document.getElementById('btnAddCategory');
  const catEditingId = document.getElementById('catEditingId');
  const catsTbody = document.getElementById('catsTbody');
  const newAdminPass = document.getElementById('newAdminPass');
  const btnChangePass = document.getElementById('btnChangePass');

  // WhatsApp Report
  const whatsappShareBtn = document.getElementById('whatsappShareBtn');
  const whatsappReportModal = new bootstrap.Modal(document.getElementById('whatsappReportModal'));
  const reportMonth = document.getElementById('reportMonth');
  const reportTotalBudget = document.getElementById('reportTotalBudget');
  const reportTotalSpent = document.getElementById('reportTotalSpent');
  const reportTotalRemaining = document.getElementById('reportTotalRemaining');
  const reportCategoriesDetails = document.getElementById('reportCategoriesDetails');
  const reportRecommendations = document.getElementById('reportRecommendations');
  const btnCopyReport = document.getElementById('btnCopyReport');
  const whatsappShareLink = document.getElementById('whatsappShareLink');

  /**********************
   * App State
   **********************/
  let role = localStorage.getItem(LS_ROLE) || null;
  let categories = {}; // {id:{name,min}}
  let settings = { totalBudget: 0 };
  let expenses = [];   // current month expenses

  function nowDateStr() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function nowMonthStr() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    return `${yyyy}-${mm}`;
  }

  function money(n){
    const x = Number(n || 0);
    return x.toLocaleString('ar-EG', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' Ø¬';
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function toast(msg, type='primary'){
    // Quick bootstrap toast-like alert
    const wrap = document.createElement('div');
    wrap.className = 'position-fixed bottom-0 start-0 p-3';
    wrap.style.zIndex = 9999;
    wrap.innerHTML = `
      <div class="alert alert-${type} shadow-soft mb-0 d-flex align-items-center" style="border-radius:14px; min-width: 260px; border: none;">
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${msg}
      </div>
    `;
    document.body.appendChild(wrap);
    setTimeout(()=>wrap.remove(), 2400);
  }

  /**********************
   * Views
   **********************/
  roleSelect.addEventListener('change', () => {
    adminPassWrap.style.display = roleSelect.value === 'admin' ? 'block' : 'none';
  });

  function showLogin(){
    loginView.classList.remove('d-none');
    mainTabs.classList.add('d-none');
    userView.classList.add('d-none');
    adminView.classList.add('d-none');
    monthSelectorContainer.classList.add('d-none');
    budgetSummary.classList.add('d-none');
    whatsappShareBtn.classList.add('d-none');
    btnRole.textContent = 'Ø§Ù„Ø¯Ø®ÙˆÙ„';
    btnRole.innerHTML = '<i class="fas fa-user me-2"></i>Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }

  function showApp(){
    loginView.classList.add('d-none');
    mainTabs.classList.remove('d-none');
    monthSelectorContainer.classList.remove('d-none');
    budgetSummary.classList.remove('d-none');
    
    if (role === 'admin') {
      btnRole.innerHTML = '<i class="fas fa-user-shield me-2"></i>Ø£Ø¯Ù…Ù†';
      // Show WhatsApp share button for admin
      whatsappShareBtn.classList.remove('d-none');
    } else {
      btnRole.innerHTML = '<i class="fas fa-user me-2"></i>Ù…Ø³ØªØ®Ø¯Ù…';
      // Show WhatsApp share button for user too
      whatsappShareBtn.classList.remove('d-none');
    }

    // show default tab
    if (role === 'admin') {
      activateTab('admin');
    } else {
      activateTab('user');
    }
  }

  function activateTab(which){
    const isUser = which === 'user';
    tabUser.classList.toggle('active', isUser);
    tabAdmin.classList.toggle('active', !isUser);

    userView.classList.toggle('d-none', !isUser);
    adminView.classList.toggle('d-none', isUser);

    // hide admin tab for user
    tabAdmin.closest('li').classList.toggle('d-none', role !== 'admin');

    if (isUser) {
      refreshUserUI();
    } else {
      refreshAdminUI();
    }
  }

  tabUser.addEventListener('click', () => activateTab('user'));
  tabAdmin.addEventListener('click', () => activateTab('admin'));

  btnRole.addEventListener('click', () => {
    if (role) showApp();
    else showLogin();
  });

  btnEnter.addEventListener('click', () => {
    const wanted = roleSelect.value;
    if (wanted === 'admin') {
      const saved = localStorage.getItem(LS_ADMIN_PASS) || DEFAULT_ADMIN_PASS;
      if ((adminPass.value || '').trim() !== saved) {
        toast('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù† ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'danger');
        return;
      }
    }
    role = wanted;
    localStorage.setItem(LS_ROLE, role);
    showApp();
    toast(`ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙƒÙ€ ${role === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³ØªØ®Ø¯Ù…'}`, 'success');
  });

  /**********************
   * Firebase Paths
   **********************/
  const refSettings = database.ref('settings');
  const refCategories = database.ref('categories');
  const refExpenses = database.ref('expenses');

  /**********************
   * Live Listeners: Settings + Categories
   **********************/
  refSettings.on('value', snap => {
    settings = snap.val() || { totalBudget: 0 };
    if (typeof settings.totalBudget !== 'number') settings.totalBudget = Number(settings.totalBudget || 0);
    refreshUserUI();
    refreshAdminUI();
  });

  refCategories.on('value', snap => {
    categories = snap.val() || {};
    refreshUserUI();
    refreshAdminUI();
  });

  /**********************
   * Expenses Loading per Month
   **********************/
  function loadExpensesForMonth(monthStr){
    // monthStr: YYYY-MM
    // Query by date string prefix
    const q = refExpenses.orderByChild('date').startAt(monthStr).endAt(monthStr + '\uf8ff');
    q.once('value').then(snap => {
      const obj = snap.val() || {};
      expenses = Object.entries(obj).map(([id, v]) => ({ id, ...v }))
        .sort((a,b) => (a.date||'').localeCompare(b.date||''));
      refreshUserUI();
    }).catch(err => {
      console.error(err);
      toast('Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ', 'danger');
    });
  }

  /**********************
   * User UI Helpers
   **********************/
  function getCategoryName(id){
    return (categories[id] && categories[id].name) ? categories[id].name : 'â€”';
  }

  function sumByCategory(categoryId){
    return expenses
      .filter(e => e.categoryId === categoryId)
      .reduce((acc, e) => acc + Number(e.amount || 0), 0);
  }

  function totalSpent(){
    return expenses.reduce((acc, e) => acc + Number(e.amount || 0), 0);
  }

  function categoryBudget(categoryId){
    return Number((categories[categoryId] && categories[categoryId].min) || 0);
  }

  function statementForCategory(spent, budget){
    if (budget <= 0) return 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.';
    const pct = budget === 0 ? 0 : (spent / budget) * 100;
    if (pct <= 60) return 'Ù…Ù…ØªØ§Ø² ğŸ‘Œ Ø§Ù„ØµØ±Ù Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯.';
    if (pct <= 90) return 'ØªÙ†Ø¨ÙŠÙ‡ âš ï¸ Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø­Ø¯.';
    if (pct <= 100) return 'Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ â›” ÙˆØµÙ„Øª ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù„Ù„Ø­Ø¯.';
    return 'ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© âŒ Ø±Ø§Ø¬Ø¹ Ù…ØµØ§Ø±ÙŠÙÙƒ.';
  }

  function getRecommendation(spent, budget){
    if (budget <= 0) return 'Ø­Ø¯Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ù„ÙØ¦Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ§Øª.';
    const pct = budget === 0 ? 0 : (spent / budget) * 100;
    if (pct <= 60) return 'âœ… Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù…ØµØ§Ø±ÙŠÙÙƒ.';
    if (pct <= 90) return 'âš ï¸ Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø­Ø¯ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙˆÙÙŠØ± ÙÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.';
    if (pct <= 100) return 'â›” Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©ØŒ ØªØ¬Ù†Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©.';
    return 'âŒ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©ØŒ ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…ØµØ§Ø±ÙŠÙÙƒ ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¥Ù†ÙØ§Ù‚.';
  }

  function refreshUserUI(){
    if (role !== 'user' && role !== 'admin') return;

    // Ensure month/date defaults
    if (!monthFilter.value) monthFilter.value = nowMonthStr();
    if (!expDate.value) expDate.value = nowDateStr();

    const monthStr = monthFilter.value;
    
    // Update month in report
    const monthNames = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
                       "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const [year, month] = monthStr.split('-');
    const monthName = monthNames[parseInt(month) - 1];
    reportMonth.textContent = `Ø´Ù‡Ø± ${monthName} ${year}`;

    // Populate category select
    const ids = Object.keys(categories);
    expCategory.innerHTML = ids.length
      ? ids.map(id => `<option value="${id}">${categories[id].name}</option>`).join('')
      : `<option value="" disabled selected>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª.. Ø£Ø¶Ù ÙØ¦Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†</option>`;

    // Update budget summary
    const tb = Number(settings.totalBudget || 0);
    const ts = totalSpent();
    const tr = tb - ts;
    
    totalBudgetText.textContent = money(tb);
    totalSpentText.textContent = money(ts);
    totalRemainingText.textContent = money(tr);

    // Color code remaining amount
    if (tr < 0) {
      totalRemainingText.className = 'budget-value text-danger';
    } else if (tr < tb * 0.2) {
      totalRemainingText.className = 'budget-value text-warning';
    } else {
      totalRemainingText.className = 'budget-value text-success';
    }

    // Render category accordion
    categoryAccordion.innerHTML = '';
    if (!ids.length) {
      categoryAccordion.innerHTML = `
        <div class="text-center py-3">
          <i class="fas fa-tags fa-2x text-muted mb-3"></i>
          <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</div>
          <div class="small text-muted mt-1">ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø§Øª Ø£ÙˆÙ„Ø§Ù‹</div>
        </div>
      `;
    } else {
      for (const id of ids) {
        const name = categories[id].name;
        const budget = categoryBudget(id);
        const spent = sumByCategory(id);
        const remaining = budget - spent;
        const pct = budget > 0 ? clamp((spent / budget) * 100, 0, 999) : 0;
        const stat = statementForCategory(spent, budget);
        
        // Determine color based on percentage
        let progressColor = 'primary';
        if (pct > 90) progressColor = 'danger';
        else if (pct > 60) progressColor = 'warning';
        else if (budget > 0) progressColor = 'success';

        const accordionItem = document.createElement('div');
        accordionItem.className = 'accordion-item';
        accordionItem.innerHTML = `
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${id}">
              <div class="d-flex align-items-center w-100">
                <div class="me-2">
                  <i class="fas fa-folder text-${progressColor}"></i>
                </div>
                <div class="flex-grow-1 text-start">
                  <div>${name}</div>
                  <div class="small text-muted">${budget > 0 ? Math.round(pct) + '% Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©' : 'Ø¨Ø¯ÙˆÙ† Ù…ÙŠØ²Ø§Ù†ÙŠØ©'}</div>
                </div>
                <div class="badge bg-${progressColor}">${money(spent)}</div>
              </div>
            </button>
          </h2>
          <div id="collapse${id}" class="accordion-collapse collapse" data-bs-parent="#categoryAccordion">
            <div class="accordion-body pt-2">
              <div class="category-details-grid">
                <div class="category-detail-card">
                  <div class="category-detail-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                  <div class="category-detail-value">${money(budget)}</div>
                </div>
                <div class="category-detail-card">
                  <div class="category-detail-label">Ø§Ù„ØµØ±Ù</div>
                  <div class="category-detail-value">${money(spent)}</div>
                </div>
                <div class="category-detail-card">
                  <div class="category-detail-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                  <div class="category-detail-value ${remaining < 0 ? 'text-danger' : remaining < budget * 0.2 ? 'text-warning' : 'text-success'}">${money(remaining)}</div>
                </div>
                <div class="category-detail-card">
                  <div class="category-detail-label">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                  <div class="category-detail-value">${budget > 0 ? Math.round(pct) + '%' : 'â€”'}</div>
                </div>
              </div>
              <div class="mt-2 small">
                <strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${stat}
              </div>
              <div class="mt-1">
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="openCategoryReport('${id}')">
                  <i class="fas fa-chart-pie me-1"></i>Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„
                </button>
              </div>
            </div>
          </div>
        `;
        categoryAccordion.appendChild(accordionItem);
      }
    }

    // Render expenses table
    expensesTbody.innerHTML = '';
    if (!expenses.length) {
      noExpenses.classList.remove('d-none');
    } else {
      noExpenses.classList.add('d-none');
      for (const e of expenses) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono text-nowrap">${e.date || ''}</td>
          <td><span class="badge bg-light text-dark">${getCategoryName(e.categoryId)}</span></td>
          <td class="mono fw-bold">${money(e.amount)}</td>
          <td class="small">${(e.notes || '').replace(/</g,'&lt;').substring(0, 30)}${(e.notes || '').length > 30 ? '...' : ''}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-danger" data-del="${e.id}" title="Ø­Ø°Ù">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        expensesTbody.appendChild(tr);
      }

      expensesTbody.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-del');
          if (!confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
          await refExpenses.child(id).remove();
          toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ', 'secondary');
          loadExpensesForMonth(monthFilter.value);
        });
      });
    }

    // Update remaining field in add form
    updateRemainingPreview();
  }

  function updateRemainingPreview(){
    const cid = expCategory.value;
    if (!cid) { expRemaining.value = 'â€”'; return; }
    const budget = categoryBudget(cid);
    const spent = sumByCategory(cid);
    const inputAmount = Number(expAmount.value || 0);
    const remainingAfter = budget - (spent + inputAmount);
    
    // Color coding for remaining amount
    let colorClass = 'text-dark';
    if (remainingAfter < 0) colorClass = 'text-danger';
    else if (remainingAfter < budget * 0.2) colorClass = 'text-warning';
    
    expRemaining.value = budget > 0 ? money(remainingAfter) : 'â€”';
    expRemaining.className = `form-control form-control-custom ${colorClass}`;
  }

  // Make function globally available for accordion buttons
  window.openCategoryReport = function(categoryId) {
    const cat = categories[categoryId];
    if (!cat) return;
    
    const budget = categoryBudget(categoryId);
    const spent = sumByCategory(categoryId);
    const remaining = budget - spent;
    const pct = budget > 0 ? clamp((spent / budget) * 100, 0, 999) : 0;
    const stat = statementForCategory(spent, budget);
    const recommendation = getRecommendation(spent, budget);
    
    // Create a simple alert with category report
    const report = `
      ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ù„ÙØ¦Ø©: ${cat.name}
      
      ğŸ“Œ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${money(budget)}
      ğŸ’° Ø§Ù„ØµØ±Ù: ${money(spent)}
      âœ… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${money(remaining)}
      ğŸ“ˆ Ø§Ù„Ù†Ø³Ø¨Ø©: ${budget > 0 ? Math.round(pct) + '%' : 'â€”'}
      
      ğŸ“‹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${stat}
      ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ©: ${recommendation}
      
      ğŸ“… Ø§Ù„Ø´Ù‡Ø±: ${monthFilter.value}
    `;
    
    // Copy to clipboard
    navigator.clipboard.writeText(report).then(() => {
      toast('ØªÙ… Ù†Ø³Ø® ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ¦Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
    }).catch(err => {
      console.error('Failed to copy: ', err);
      // Fallback method
      const textArea = document.createElement('textarea');
      textArea.value = report;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      toast('ØªÙ… Ù†Ø³Ø® ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ¦Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
    });
  };

  expCategory.addEventListener('change', updateRemainingPreview);
  expAmount.addEventListener('input', updateRemainingPreview);

  monthFilter.addEventListener('change', () => {
    loadExpensesForMonth(monthFilter.value);
  });

  btnAddExpense.addEventListener('click', async () => {
    const date = expDate.value;
    const categoryId = expCategory.value;
    const amount = Number(expAmount.value || 0);
    const notes = (expNotes.value || '').trim();

    if (!date || !categoryId) return toast('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙØ¦Ø©', 'warning');
    if (!isFinite(amount) || amount <= 0) return toast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'warning');

    const payload = {
      date,
      categoryId,
      amount,
      notes,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    try {
      await refExpenses.push(payload);
      toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
      expAmount.value = '';
      expNotes.value = '';
      updateRemainingPreview();
      // reload current month
      loadExpensesForMonth(monthFilter.value);
    } catch (e) {
      console.error(e);
      toast('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ', 'danger');
    }
  });

  btnExportCsv.addEventListener('click', () => {
    if (!expenses.length) return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
    const lines = [
      ['date','category','amount','notes'].join(',')
    ];
    for (const e of expenses) {
      const row = [
        e.date || '',
        (getCategoryName(e.categoryId) || '').replaceAll(',', ' '),
        Number(e.amount || 0),
        (e.notes || '').replaceAll(',', ' ').replaceAll('\n',' ')
      ];
      lines.push(row.join(','));
    }
    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `expenses_${monthFilter.value}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
  });

  /**********************
   * WhatsApp Report
   **********************/
  whatsappShareBtn.addEventListener('click', () => {
    generateWhatsAppReport();
    whatsappReportModal.show();
  });

  function generateWhatsAppReport() {
    const monthStr = monthFilter.value;
    const [year, month] = monthStr.split('-');
    const monthNames = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
                       "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const monthName = monthNames[parseInt(month) - 1];
    
    // Budget summary
    const tb = Number(settings.totalBudget || 0);
    const ts = totalSpent();
    const tr = tb - ts;
    
    reportTotalBudget.textContent = money(tb);
    reportTotalSpent.textContent = money(ts);
    reportTotalRemaining.textContent = money(tr);
    
    // Categories details
    const ids = Object.keys(categories);
    let categoriesHtml = '';
    let categoriesText = '';
    
    if (ids.length === 0) {
      categoriesHtml = '<div class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª</div>';
      categoriesText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª';
    } else {
      categoriesHtml = '<div class="row g-2">';
      
      for (const id of ids) {
        const name = categories[id].name;
        const budget = categoryBudget(id);
        const spent = sumByCategory(id);
        const remaining = budget - spent;
        const pct = budget > 0 ? clamp((spent / budget) * 100, 0, 999) : 0;
        
        categoriesHtml += `
          <div class="col-6">
            <div class="bg-light p-2 rounded mb-2">
              <div class="fw-bold small">${name}</div>
              <div class="d-flex justify-content-between small">
                <span>Ø§Ù„ØµØ±Ù:</span>
                <span class="fw-bold">${money(spent)}</span>
              </div>
              <div class="d-flex justify-content-between small">
                <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                <span class="fw-bold ${remaining < 0 ? 'text-danger' : remaining < budget * 0.2 ? 'text-warning' : 'text-success'}">${money(remaining)}</span>
              </div>
              <div class="d-flex justify-content-between small">
                <span>Ø§Ù„Ù†Ø³Ø¨Ø©:</span>
                <span class="fw-bold">${budget > 0 ? Math.round(pct) + '%' : 'â€”'}</span>
              </div>
            </div>
          </div>
        `;
        
        categoriesText += `ğŸ“Œ ${name}: ${money(spent)} Ù…Ù† ${money(budget)} (${budget > 0 ? Math.round(pct) + '%' : 'â€”'})\n`;
      }
      
      categoriesHtml += '</div>';
    }
    
    reportCategoriesDetails.innerHTML = categoriesHtml;
    
    // Recommendations
    let recommendationsHtml = '';
    let recommendationsText = '';
    
    if (tr < 0) {
      recommendationsHtml = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©! ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.</div>';
      recommendationsText = 'âŒ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©! ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.';
    } else if (tr < tb * 0.2) {
      recommendationsHtml = '<div class="text-warning"><i class="fas fa-exclamation-circle me-2"></i>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù‚Ù„ÙŠÙ„ØŒ ØªØ¬Ù†Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©.</div>';
      recommendationsText = 'âš ï¸ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù‚Ù„ÙŠÙ„ØŒ ØªØ¬Ù†Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©.';
    } else if (tr < tb * 0.5) {
      recommendationsHtml = '<div class="text-info"><i class="fas fa-info-circle me-2"></i>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.</div>';
      recommendationsText = 'â„¹ï¸ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.';
    } else {
      recommendationsHtml = '<div class="text-success"><i class="fas fa-check-circle me-2"></i>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø­Ùˆ.</div>';
      recommendationsText = 'âœ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø­Ùˆ.';
    }
    
    reportRecommendations.innerHTML = recommendationsHtml;
    
    // Prepare WhatsApp message
    const whatsappMessage = `ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª - ${monthName} ${year}

ğŸ’° Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:
â€¢ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©: ${money(tb)}
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ±Ù: ${money(ts)}
â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${money(tr)}

ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª:
${categoriesText}

ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ©:
${recommendationsText}

ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${nowDateStr()}
ğŸ“± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª`;

    // Set up WhatsApp share link
    const encodedMessage = encodeURIComponent(whatsappMessage);
    whatsappShareLink.href = `https://wa.me/?text=${encodedMessage}`;
    
    // Set up copy button
    btnCopyReport.onclick = () => {
      navigator.clipboard.writeText(whatsappMessage).then(() => {
        toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
      }).catch(err => {
        console.error('Failed to copy: ', err);
        // Fallback method
        const textArea = document.createElement('textarea');
        textArea.value = whatsappMessage;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
      });
    };
  }

  /**********************
   * Admin UI
   **********************/
  function refreshAdminUI(){
    if (role !== 'admin') return;

    adminTotalBudget.value = Number(settings.totalBudget || 0);

    catsTbody.innerHTML = '';
    const ids = Object.keys(categories);
    if (!ids.length) {
      catsTbody.innerHTML = `<tr><td colspan="3" class="muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª.</td></tr>`;
      return;
    }

    for (const id of ids) {
      const c = categories[id];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-2">
              <i class="fas fa-tag"></i>
            </div>
            <div class="fw-bold">${c.name}</div>
          </div>
        </td>
        <td class="mono fw-bold">${money(c.min)}</td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-primary me-1" data-edit="${id}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" data-delcat="${id}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      catsTbody.appendChild(tr);
    }

    catsTbody.querySelectorAll('[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-edit');
        const c = categories[id];
        catName.value = c.name || '';
        catMin.value = Number(c.min || 0);
        catEditingId.value = id;
        btnAddCategory.innerHTML = '<i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
        catName.focus();
        toast('Ø¹Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'info');
      });
    });

    catsTbody.querySelectorAll('[data-delcat]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-delcat');
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ (Ù„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)')) return;
        await refCategories.child(id).remove();
        toast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­', 'secondary');
        // If category deleted, refresh user select too
        refreshUserUI();
      });
    });
  }

  btnSaveTotalBudget.addEventListener('click', async () => {
    if (role !== 'admin') return;
    const v = Number(adminTotalBudget.value || 0);
    if (!isFinite(v) || v < 0) return toast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', 'warning');
    try {
      await refSettings.update({ totalBudget: v });
      toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
    } catch (e) {
      console.error(e);
      toast('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', 'danger');
    }
  });

  btnAddCategory.addEventListener('click', async () => {
    if (role !== 'admin') return;

    const name = (catName.value || '').trim();
    const min = Number(catMin.value || 0);
    if (!name) return toast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©', 'warning');
    if (!isFinite(min) || min < 0) return toast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ù„ÙØ¦Ø©', 'warning');

    const id = (catEditingId.value || '').trim();
    const payload = { name, min };

    try {
      if (id) {
        await refCategories.child(id).update(payload);
        toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
      } else {
        await refCategories.push(payload);
        toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
      }
      catName.value = '';
      catMin.value = '';
      catEditingId.value = '';
      btnAddCategory.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©';
    } catch (e) {
      console.error(e);
      toast('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'danger');
    }
  });

  btnChangePass.addEventListener('click', () => {
    if (role !== 'admin') return;
    const p = (newAdminPass.value || '').trim();
    if (p.length < 4) return toast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±', 'warning');
    localStorage.setItem(LS_ADMIN_PASS, p);
    newAdminPass.value = '';
    toast('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
  });

  /**********************
   * Init
   **********************/
  // Default month + date
  monthFilter.value = nowMonthStr();
  expDate.value = nowDateStr();

  // Load expenses initially
  loadExpensesForMonth(monthFilter.value);

  // Re-load expenses after role changes to user/admin
  mainTabs.addEventListener('click', () => loadExpensesForMonth(monthFilter.value));

  // Render initial view
  if (role) {
    showApp();
  } else {
    showLogin();
  }

  // When month changes, reload expenses
  monthFilter.addEventListener('change', () => {
    loadExpensesForMonth(monthFilter.value);
  });
</script>

</body>
</html>
